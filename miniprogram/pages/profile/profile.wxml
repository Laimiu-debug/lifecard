<!--pages/profile/profile.wxml-->
<!--
  ä¸ªäººä¸­å¿ƒé¡µé¢
  æ˜¾ç¤ºç”¨æˆ·èµ„æ–™ã€ç»Ÿè®¡æ•°æ®ã€é‡‘å¸ä½™é¢
  Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 11.1
-->
<view class="page-container">
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="login-prompt" wx:if="{{!isLoggedIn}}">
    <image src="/assets/images/default-avatar.png" class="avatar-placeholder" mode="aspectFill" />
    <text class="login-text">ç™»å½•åæŸ¥çœ‹ä¸ªäººä¿¡æ¯</text>
    <button class="btn btn-primary login-btn" bindtap="onLogin">å¾®ä¿¡ç™»å½•</button>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <block wx:else>
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="profile-card">
      <view class="profile-header">
        <image 
          src="{{profile.avatar_url || '/assets/images/default-avatar.png'}}" 
          class="avatar-lg"
          mode="aspectFill"
        />
        <view class="profile-info">
          <text class="nickname">{{profile.nickname || 'ç”¨æˆ·'}}</text>
          <text class="bio text-ellipsis">{{profile.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}}</text>
          <view class="profile-meta" wx:if="{{profile.location}}">
            <text class="meta-icon">ğŸ“</text>
            <text class="meta-text">{{profile.location}}</text>
          </view>
        </view>
        <view class="edit-btn" bindtap="onEditProfile">
          <text class="edit-icon">âœï¸</text>
          <text>ç¼–è¾‘</text>
        </view>
      </view>

      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-row">
        <view class="stat-item" bindtap="onViewFollowing">
          <text class="stat-value">{{stats.followingCount}}</text>
          <text class="stat-label">å…³æ³¨</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item" bindtap="onViewFollowers">
          <text class="stat-value">{{stats.followerCount}}</text>
          <text class="stat-label">ç²‰ä¸</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item" bindtap="onViewMyCards">
          <text class="stat-value">{{stats.cardCount}}</text>
          <text class="stat-label">å¡ç‰‡</text>
        </view>
      </view>
    </view>

    <!-- é‡‘å¸ä½™é¢å¡ç‰‡ -->
    <view class="coin-card" bindtap="onViewTransactions">
      <view class="coin-left">
        <view class="coin-icon-wrapper">
          <text class="coin-icon">ğŸª™</text>
        </view>
        <view class="coin-info">
          <text class="coin-label">é‡‘å¸ä½™é¢</text>
          <text class="coin-hint">ç‚¹å‡»æŸ¥çœ‹äº¤æ˜“è®°å½•</text>
        </view>
      </view>
      <view class="coin-right">
        <text class="coin-amount">{{coinBalance}}</text>
        <text class="arrow-icon">â€º</text>
      </view>
    </view>

    <!-- åŠŸèƒ½èœå• -->
    <view class="menu-section">
      <view class="section-title">æˆ‘çš„æœåŠ¡</view>
      <view class="menu-grid">
        <view class="menu-grid-item" bindtap="onViewMyCards">
          <view class="menu-icon-wrapper">
            <text class="menu-icon">ğŸ“</text>
          </view>
          <text class="menu-text">æˆ‘çš„å¡ç‰‡</text>
        </view>
        <view class="menu-grid-item" bindtap="onViewExchanges">
          <view class="menu-icon-wrapper">
            <text class="menu-icon">ğŸ”„</text>
          </view>
          <text class="menu-text">äº¤æ¢ç®¡ç†</text>
        </view>
        <view class="menu-grid-item" bindtap="onViewNotifications">
          <view class="menu-icon-wrapper notification-icon-wrapper">
            <text class="menu-icon">ğŸ””</text>
            <!-- æœªè¯»é€šçŸ¥å¾½ç«  Requirements: 10.1 -->
            <view class="notification-badge" wx:if="{{unreadCount > 0}}">
              <text>{{unreadCount > 99 ? '99+' : unreadCount}}</text>
            </view>
          </view>
          <text class="menu-text">æ¶ˆæ¯é€šçŸ¥</text>
        </view>
        <view class="menu-grid-item" bindtap="onViewFollowing">
          <view class="menu-icon-wrapper">
            <text class="menu-icon">ğŸ‘¥</text>
          </view>
          <text class="menu-text">æˆ‘çš„å…³æ³¨</text>
        </view>
      </view>
    </view>

    <!-- è®¾ç½®èœå• -->
    <view class="menu-list">
      <view class="menu-item" bindtap="onSettings">
        <text class="menu-item-icon">âš™ï¸</text>
        <text class="menu-item-text">è®¾ç½®</text>
        <text class="menu-item-arrow">â€º</text>
      </view>
      <view class="menu-item" bindtap="onAbout">
        <text class="menu-item-icon">â„¹ï¸</text>
        <text class="menu-item-text">å…³äºæˆ‘ä»¬</text>
        <text class="menu-item-arrow">â€º</text>
      </view>
      <view class="menu-item logout-item" bindtap="onLogout">
        <text class="menu-item-icon">ğŸšª</text>
        <text class="menu-item-text text-danger">é€€å‡ºç™»å½•</text>
        <text class="menu-item-arrow">â€º</text>
      </view>
    </view>

    <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
    <view class="version-info">
      <text>Life Card v1.0.0</text>
    </view>
  </block>

  <!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showEditModal}}" bindtap="onCloseEditModal">
    <view class="modal-content" catchtap="">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘èµ„æ–™</text>
        <view class="modal-close" bindtap="onCloseEditModal">âœ•</view>
      </view>

      <!-- å¼¹çª—å†…å®¹ -->
      <scroll-view class="modal-body" scroll-y>
        <!-- å¤´åƒç¼–è¾‘ -->
        <view class="form-item avatar-form-item">
          <view class="form-label">å¤´åƒ</view>
          <view class="avatar-edit-wrapper" bindtap="onChangeAvatar">
            <image 
              src="{{editForm.avatar_url || '/assets/images/default-avatar.png'}}" 
              class="avatar-edit"
              mode="aspectFill"
            />
            <view class="avatar-edit-overlay">
              <text class="avatar-edit-icon">ğŸ“·</text>
            </view>
            <view class="avatar-loading" wx:if="{{uploadingAvatar}}">
              <view class="loading-spinner-small"></view>
            </view>
          </view>
        </view>

        <!-- æ˜µç§° -->
        <view class="form-item">
          <view class="form-label">
            <text>æ˜µç§°</text>
            <text class="required">*</text>
          </view>
          <input 
            class="form-input {{formErrors.nickname ? 'input-error' : ''}}"
            type="text"
            placeholder="è¯·è¾“å…¥æ˜µç§°"
            value="{{editForm.nickname}}"
            maxlength="50"
            bindinput="onNicknameInput"
          />
          <view class="form-error" wx:if="{{formErrors.nickname}}">
            {{formErrors.nickname}}
          </view>
          <view class="form-hint">
            <text>{{editForm.nickname.length}}/50</text>
          </view>
        </view>

        <!-- ç®€ä»‹ -->
        <view class="form-item">
          <view class="form-label">ç®€ä»‹</view>
          <textarea 
            class="form-textarea {{formErrors.bio ? 'input-error' : ''}}"
            placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§"
            value="{{editForm.bio}}"
            maxlength="500"
            bindinput="onBioInput"
            auto-height
          />
          <view class="form-error" wx:if="{{formErrors.bio}}">
            {{formErrors.bio}}
          </view>
          <view class="form-hint">
            <text>{{editForm.bio.length}}/500</text>
          </view>
        </view>

        <!-- å¹´é¾„èŒƒå›´ -->
        <view class="form-item">
          <view class="form-label">å¹´é¾„èŒƒå›´</view>
          <picker 
            mode="selector" 
            range="{{ageRangeOptions}}"
            value="{{ageRangeIndex}}"
            bindchange="onAgeRangeChange"
          >
            <view class="form-picker">
              <text class="{{editForm.age_range ? '' : 'placeholder'}}">
                {{editForm.age_range || 'è¯·é€‰æ‹©å¹´é¾„èŒƒå›´'}}
              </text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>

        <!-- æ‰€åœ¨åœ° -->
        <view class="form-item">
          <view class="form-label">æ‰€åœ¨åœ°</view>
          <input 
            class="form-input"
            type="text"
            placeholder="è¯·è¾“å…¥æ‰€åœ¨åœ°"
            value="{{editForm.location}}"
            maxlength="100"
            bindinput="onLocationInput"
          />
        </view>
      </scroll-view>

      <!-- å¼¹çª—åº•éƒ¨ -->
      <view class="modal-footer">
        <button 
          class="btn btn-secondary" 
          bindtap="onCloseEditModal"
          disabled="{{submitting}}"
        >å–æ¶ˆ</button>
        <button 
          class="btn btn-primary" 
          bindtap="onSubmitProfile"
          disabled="{{submitting || uploadingAvatar}}"
          loading="{{submitting}}"
        >ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
  </view>
</view>
