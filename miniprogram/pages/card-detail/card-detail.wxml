<!--
  å¡ç‰‡è¯¦æƒ…é¡µ
  æ˜¾ç¤ºåª’ä½“è½®æ’­ã€å¡ç‰‡ä¿¡æ¯ã€æ ‡ç­¾ã€è¯„è®ºç­‰
  Requirements: 6.1, 7.1, 7.2, 12.1, 12.2, 12.3
-->
<view class="page-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{errorMessage}}" class="error-container">
    <empty-state
      type="error"
      title="åŠ è½½å¤±è´¥"
      description="{{errorMessage}}"
      actionText="é‡è¯•"
      bind:action="onRetry"
    />
  </view>

  <!-- å¡ç‰‡å†…å®¹ -->
  <block wx:elif="{{card}}">
    <!-- åª’ä½“è½®æ’­åŒºåŸŸ -->
    <view class="media-section">
      <swiper 
        wx:if="{{card.media.length > 0}}"
        class="media-swiper" 
        indicator-dots="{{card.media.length > 1}}"
        indicator-color="rgba(255,255,255,0.5)"
        indicator-active-color="#ffffff"
        circular="{{card.media.length > 1}}"
        bindchange="onSwiperChange"
      >
        <swiper-item wx:for="{{card.media}}" wx:key="id">
          <!-- å›¾ç‰‡ -->
          <image 
            wx:if="{{item.media_type === 'image'}}"
            src="{{item.url}}" 
            mode="aspectFill" 
            class="media-image"
            bindtap="onPreviewImage"
            data-url="{{item.url}}"
            lazy-load
          />
          <!-- è§†é¢‘ -->
          <video
            wx:else
            id="card-video"
            class="media-video"
            src="{{item.url}}"
            poster="{{item.thumbnail_url}}"
            controls
            show-center-play-btn
            object-fit="cover"
            data-url="{{item.url}}"
            bindtap="onPreviewVideo"
          />
        </swiper-item>
      </swiper>
      
      <!-- æ— åª’ä½“å ä½ -->
      <view wx:else class="media-placeholder">
        <text class="media-placeholder-icon">ğŸ“·</text>
        <text class="media-placeholder-text">æš‚æ— å›¾ç‰‡</text>
      </view>

      <!-- åª’ä½“è®¡æ•°æŒ‡ç¤ºå™¨ -->
      <view wx:if="{{card.media.length > 1}}" class="media-counter">
        <text>{{currentMediaIndex + 1}}/{{card.media.length}}</text>
      </view>
    </view>

    <!-- å¡ç‰‡ä¿¡æ¯åŒºåŸŸ -->
    <view class="card-content">
      <!-- ç±»å‹æ ‡ç­¾ -->
      <view class="type-tag" style="background-color: {{cardTypeColor}}20; color: {{cardTypeColor}};">
        {{cardTypeLabel}}
      </view>

      <!-- æ ‡é¢˜ -->
      <text class="card-title">{{card.title}}</text>

      <!-- åˆ›å»ºè€…ä¿¡æ¯ -->
      <view class="creator-section" bindtap="onCreatorTap">
        <user-avatar 
          src="{{card.creator.avatar_url}}" 
          size="80"
          border="{{true}}"
        />
        <view class="creator-info">
          <text class="creator-name">{{card.creator.nickname || 'æœªçŸ¥ç”¨æˆ·'}}</text>
          <text class="created-time">{{createdTimeText}}</text>
        </view>
        <button 
          wx:if="{{!isOwner}}" 
          class="follow-btn {{isFollowing ? 'follow-btn--following' : ''}}"
          catchtap="onFollow"
        >
          {{isFollowing ? 'å·²å…³æ³¨' : '+ å…³æ³¨'}}
        </button>
      </view>

      <!-- æè¿° -->
      <view class="description-section">
        <text class="card-description">{{card.description}}</text>
      </view>

      <!-- ä½ç½®ä¿¡æ¯ -->
      <view wx:if="{{card.location}}" class="location-section" bindtap="onLocationTap">
        <text class="location-icon">ğŸ“</text>
        <text class="location-name">{{card.location.name}}</text>
        <text class="location-arrow">â€º</text>
      </view>

      <!-- æ ‡ç­¾åŒºåŸŸ -->
      <view wx:if="{{card.interest_tags.length > 0 || card.emotion_tags.length > 0}}" class="tags-section">
        <!-- å…´è¶£æ ‡ç­¾ -->
        <view 
          wx:for="{{card.interest_tags}}" 
          wx:key="*this" 
          class="tag tag-interest"
          data-tag="{{item}}"
          data-type="interest"
          bindtap="onTagTap"
        >
          <text class="tag-icon">ğŸ·ï¸</text>
          <text>{{item}}</text>
        </view>
        <!-- æƒ…ç»ªæ ‡ç­¾ -->
        <view 
          wx:for="{{card.emotion_tags}}" 
          wx:key="*this" 
          class="tag tag-emotion"
          data-tag="{{item}}"
          data-type="emotion"
          bindtap="onTagTap"
        >
          <text class="tag-icon">ğŸ˜Š</text>
          <text>{{item}}</text>
        </view>
      </view>

      <!-- äº’åŠ¨ç»Ÿè®¡ -->
      <view class="stats-section">
        <view class="stat-item">
          <text class="stat-icon">â¤ï¸</text>
          <text class="stat-value">{{likeCountText}}</text>
          <text class="stat-label">ç‚¹èµ</text>
        </view>
        <view class="stat-item">
          <text class="stat-icon">ğŸ’¬</text>
          <text class="stat-value">{{commentCountText}}</text>
          <text class="stat-label">è¯„è®º</text>
        </view>
        <view class="stat-item">
          <text class="stat-icon">ğŸ”„</text>
          <text class="stat-value">{{exchangeCountText}}</text>
          <text class="stat-label">äº¤æ¢</text>
        </view>
      </view>

      <!-- åˆ†å‰²çº¿ -->
      <view class="divider"></view>

      <!-- è¯„è®ºåŒºåŸŸ -->
      <view class="comments-section">
        <comment-list
          cardId="{{cardId}}"
          currentUserId="{{currentUserId}}"
          showInput="{{true}}"
          placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
          bind:load="onCommentsLoad"
          bind:submit="onCommentSubmit"
          bind:tapuser="onTapCommentUser"
        />
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  - å ä½ -->
    <view class="action-bar-placeholder"></view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="action-bar safe-area-bottom">
      <!-- å·¦ä¾§äº’åŠ¨æŒ‰é’® -->
      <view class="action-left">
        <!-- ç‚¹èµæŒ‰é’® -->
        <view class="action-item {{card.is_liked ? 'action-item--active' : ''}}" data-action="like" bindtap="onLike">
          <text class="action-icon">{{card.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="action-count">{{likeCountText}}</text>
        </view>
        <!-- è¯„è®ºæŒ‰é’® -->
        <view class="action-item" data-action="comment">
          <text class="action-icon">ğŸ’¬</text>
          <text class="action-count">{{commentCountText}}</text>
        </view>
        <!-- åˆ†äº«æŒ‰é’® (Requirements: 12.1, 12.2, 12.3) -->
        <button class="action-item action-share" open-type="share">
          <text class="action-icon">ğŸ“¤</text>
          <text class="action-count">åˆ†äº«</text>
        </button>
        <!-- æµ·æŠ¥æŒ‰é’® (Requirements: 12.4) -->
        <view class="action-item" bindtap="onShowPoster">
          <text class="action-icon">ğŸ–¼ï¸</text>
          <text class="action-count">æµ·æŠ¥</text>
        </view>
      </view>
      
      <!-- å³ä¾§æ“ä½œæŒ‰é’® - æ ¹æ®æ‰€æœ‰æƒæ˜¾ç¤ºä¸åŒæŒ‰é’® -->
      <!-- Requirements: 6.6, 6.7, 7.3, 7.4 -->
      <view class="action-right">
        <!-- éæ‰€æœ‰è€…ï¼šæ˜¾ç¤ºäº¤æ¢æŒ‰é’®å’Œä»·æ ¼ (Requirement 6.6) -->
        <block wx:if="{{!isOwner}}">
          <!-- å·²æ”¶è—çŠ¶æ€ -->
          <view wx:if="{{card.is_collected}}" class="collected-badge">
            <text class="collected-icon">âœ…</text>
            <text>å·²æ”¶è—</text>
          </view>
          <!-- å¾…å¤„ç†äº¤æ¢è¯·æ±‚çŠ¶æ€ (Requirement 7.4) -->
          <view wx:elif="{{hasPendingExchange}}" class="pending-badge">
            <text class="pending-icon">â³</text>
            <text>ç­‰å¾…å¯¹æ–¹ç¡®è®¤</text>
          </view>
          <!-- å¯äº¤æ¢çŠ¶æ€ -->
          <button 
            wx:else
            class="exchange-btn"
            data-action="exchange"
            bindtap="onExchange"
          >
            ğŸ”„ {{card.exchange_price}} é‡‘å¸äº¤æ¢
          </button>
        </block>
        
        <!-- æ‰€æœ‰è€…ï¼šæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® (Requirement 6.7) -->
        <block wx:else>
          <view class="owner-actions">
            <button class="edit-btn" data-action="edit" bindtap="onEdit">
              âœï¸ ç¼–è¾‘
            </button>
            <button class="delete-btn" data-action="delete" bindtap="onDelete">
              ğŸ—‘ï¸ åˆ é™¤
            </button>
          </view>
        </block>
      </view>
    </view>
  </block>

  <!-- äº¤æ¢ç¡®è®¤å¼¹çª— (Requirements: 7.1, 7.2) -->
  <view wx:if="{{showExchangeDialog}}" class="exchange-dialog-mask" catchtap="onCloseExchangeDialog">
    <view class="exchange-dialog" catchtap="">
      <!-- å¼¹çª—æ ‡é¢˜ -->
      <view class="exchange-dialog-header">
        <text class="exchange-dialog-title">ç¡®è®¤äº¤æ¢</text>
        <view class="exchange-dialog-close" bindtap="onCloseExchangeDialog">âœ•</view>
      </view>

      <!-- å¡ç‰‡ä¿¡æ¯ -->
      <view class="exchange-card-info">
        <image 
          class="exchange-card-thumb" 
          src="{{card.media[0].thumbnail_url || card.media[0].url || '/assets/images/card-placeholder.png'}}" 
          mode="aspectFill"
        />
        <view class="exchange-card-detail">
          <text class="exchange-card-title">{{card.title}}</text>
          <text class="exchange-card-creator">åˆ›å»ºè€…: {{card.creator.nickname || 'æœªçŸ¥ç”¨æˆ·'}}</text>
        </view>
      </view>

      <!-- ä»·æ ¼å’Œä½™é¢ä¿¡æ¯ (Requirement 7.1) -->
      <view class="exchange-price-section">
        <!-- äº¤æ¢ä»·æ ¼ -->
        <view class="exchange-price-row">
          <text class="exchange-price-label">äº¤æ¢ä»·æ ¼</text>
          <text class="exchange-price-value">{{exchangePriceInfo.total_price || card.exchange_price}} é‡‘å¸</text>
        </view>
        
        <!-- ä»·æ ¼æ˜ç»†ï¼ˆå¦‚æœæœ‰åŠ æˆï¼‰ -->
        <block wx:if="{{exchangePriceInfo && exchangePriceInfo.popularity_bonus > 0}}">
          <view class="exchange-price-detail">
            <text class="exchange-price-detail-item">åŸºç¡€ä»·æ ¼: {{exchangePriceInfo.base_price}} é‡‘å¸</text>
            <text class="exchange-price-detail-item">çƒ­åº¦åŠ æˆ: +{{exchangePriceInfo.popularity_bonus}} é‡‘å¸</text>
          </view>
        </block>

        <!-- åˆ†å‰²çº¿ -->
        <view class="exchange-divider"></view>

        <!-- å½“å‰ä½™é¢ -->
        <view class="exchange-balance-row">
          <text class="exchange-balance-label">å½“å‰ä½™é¢</text>
          <text class="exchange-balance-value {{hasEnoughBalance ? '' : 'exchange-balance-insufficient'}}">
            {{userCoinBalance}} é‡‘å¸
          </text>
        </view>

        <!-- ä½™é¢ä¸è¶³æç¤º (Requirement 7.2) -->
        <view wx:if="{{!hasEnoughBalance}}" class="exchange-insufficient-tip">
          <text class="exchange-insufficient-icon">âš ï¸</text>
          <text class="exchange-insufficient-text">ä½™é¢ä¸è¶³ï¼Œæ— æ³•å®Œæˆäº¤æ¢</text>
        </view>

        <!-- äº¤æ¢åä½™é¢ -->
        <view wx:if="{{hasEnoughBalance}}" class="exchange-after-row">
          <text class="exchange-after-label">äº¤æ¢åä½™é¢</text>
          <text class="exchange-after-value">{{userCoinBalance - (exchangePriceInfo.total_price || card.exchange_price)}} é‡‘å¸</text>
        </view>
      </view>

      <!-- ç•™è¨€è¾“å…¥ï¼ˆå¯é€‰ï¼‰ -->
      <view class="exchange-message-section">
        <text class="exchange-message-label">ç»™å¡ç‰‡ä¸»äººç•™è¨€ï¼ˆå¯é€‰ï¼‰</text>
        <textarea 
          class="exchange-message-input"
          placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..."
          maxlength="200"
          value="{{exchangeMessage}}"
          bindinput="onExchangeMessageInput"
        />
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="exchange-dialog-actions">
        <button class="exchange-cancel-btn" bindtap="onCloseExchangeDialog">å–æ¶ˆ</button>
        <button 
          class="exchange-confirm-btn {{!hasEnoughBalance ? 'exchange-confirm-btn--disabled' : ''}}"
          disabled="{{!hasEnoughBalance || exchangeLoading}}"
          loading="{{exchangeLoading}}"
          bindtap="onConfirmExchange"
        >
          {{exchangeLoading ? 'å¤„ç†ä¸­...' : (hasEnoughBalance ? 'ç¡®è®¤äº¤æ¢' : 'ä½™é¢ä¸è¶³')}}
        </button>
      </view>
    </view>
  </view>

  <!-- æµ·æŠ¥ç”Ÿæˆå¼¹çª— (Requirements: 12.4) -->
  <view wx:if="{{showPosterDialog}}" class="poster-dialog-mask" catchtap="onClosePosterDialog">
    <view class="poster-dialog" catchtap="">
      <!-- å¼¹çª—æ ‡é¢˜ -->
      <view class="poster-dialog-header">
        <text class="poster-dialog-title">åˆ†äº«æµ·æŠ¥</text>
        <view class="poster-dialog-close" bindtap="onClosePosterDialog">âœ•</view>
      </view>

      <!-- æµ·æŠ¥é¢„è§ˆåŒºåŸŸ -->
      <view class="poster-preview-area">
        <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
        <view wx:if="{{posterGenerating}}" class="poster-loading">
          <view class="poster-loading-spinner"></view>
          <text class="poster-loading-text">æ­£åœ¨ç”Ÿæˆæµ·æŠ¥...</text>
        </view>
        
        <!-- æµ·æŠ¥å›¾ç‰‡ -->
        <image 
          wx:elif="{{posterImagePath}}"
          class="poster-image"
          src="{{posterImagePath}}"
          mode="aspectFit"
          bindtap="onPreviewPoster"
        />
        
        <!-- ç”Ÿæˆå¤±è´¥å ä½ -->
        <view wx:else class="poster-error">
          <text class="poster-error-icon">ğŸ˜•</text>
          <text class="poster-error-text">æµ·æŠ¥ç”Ÿæˆå¤±è´¥</text>
          <button class="poster-retry-btn" bindtap="generateCardPoster">é‡è¯•</button>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="poster-dialog-actions">
        <button 
          class="poster-save-btn"
          disabled="{{posterGenerating || !posterImagePath}}"
          bindtap="onSavePoster"
        >
          ä¿å­˜åˆ°ç›¸å†Œ
        </button>
      </view>

      <!-- æç¤ºæ–‡å­— -->
      <view class="poster-tip">
        <text>ä¿å­˜æµ·æŠ¥åå¯åˆ†äº«åˆ°æœ‹å‹åœˆ</text>
      </view>
    </view>
  </view>

  <!-- éšè—çš„ Canvas ç”¨äºç”Ÿæˆæµ·æŠ¥ -->
  <canvas 
    canvas-id="posterCanvas" 
    class="poster-canvas"
    style="width: 750px; height: 1200px; position: fixed; left: -9999px; top: -9999px;"
  />
</view>
