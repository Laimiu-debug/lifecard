<!--pages/my-cards/my-cards.wxml-->
<!-- æˆ‘çš„å¡ç‰‡é¡µé¢ -->
<!-- Requirements: 8.1 - å®ç°åˆ›å»º/æ”¶è— Tab åˆ‡æ¢ -->
<!-- Requirements: 8.2, 8.3, 8.5 - æ–‡ä»¶å¤¹ç®¡ç† -->
<!-- Requirements: 8.6, 8.7 - æ—¶é—´çº¿å’Œåˆ†ç±»è§†å›¾ -->

<view class="page-container">
  <!-- Tab åˆ‡æ¢ -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 'created' ? 'active' : ''}}"
      data-tab="created"
      bindtap="onTabChange"
    >
      <text class="tab-text">æˆ‘åˆ›å»ºçš„</text>
      <text class="tab-count" wx:if="{{createdCount > 0}}">({{createdCount}})</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'collected' ? 'active' : ''}}"
      data-tab="collected"
      bindtap="onTabChange"
    >
      <text class="tab-text">æˆ‘æ”¶è—çš„</text>
      <text class="tab-count" wx:if="{{collectedCount > 0}}">({{collectedCount}})</text>
    </view>
  </view>

  <!-- è§†å›¾æ¨¡å¼åˆ‡æ¢ -->
  <!-- Requirements: 8.6, 8.7 - æ—¶é—´çº¿å’Œåˆ†ç±»è§†å›¾ -->
  <view class="view-mode-bar">
    <view class="view-mode-left">
      <view 
        class="view-mode-item {{viewMode === 'list' ? 'active' : ''}}"
        data-mode="list"
        bindtap="onViewModeChange"
      >
        <text class="view-mode-icon">ğŸ“‹</text>
        <text class="view-mode-text">åˆ—è¡¨</text>
      </view>
      <view 
        class="view-mode-item {{viewMode === 'timeline' ? 'active' : ''}}"
        data-mode="timeline"
        bindtap="onViewModeChange"
      >
        <text class="view-mode-icon">ğŸ“…</text>
        <text class="view-mode-text">æ—¶é—´çº¿</text>
      </view>
      <view 
        class="view-mode-item {{viewMode === 'category' ? 'active' : ''}}"
        data-mode="category"
        bindtap="onViewModeChange"
      >
        <text class="view-mode-icon">ğŸ“‚</text>
        <text class="view-mode-text">åˆ†ç±»</text>
      </view>
    </view>
    <view class="view-mode-right">
      <text class="total-count">å…± {{total}} å¼ </text>
    </view>
  </view>

  <!-- æ–‡ä»¶å¤¹åŒºåŸŸï¼ˆä»…æ”¶è— Tab æ˜¾ç¤ºï¼‰ -->
  <view class="folder-section" wx:if="{{activeTab === 'collected'}}">
    <view class="folder-header">
      <text class="folder-title">æ–‡ä»¶å¤¹</text>
      <view class="folder-add-btn" bindtap="onShowCreateFolder">
        <text class="add-icon">+</text>
        <text class="add-text">æ–°å»º</text>
      </view>
    </view>
    
    <scroll-view class="folder-scroll" scroll-x wx:if="{{folders.length > 0}}">
      <!-- å…¨éƒ¨å¡ç‰‡é€‰é¡¹ -->
      <view 
        class="folder-item {{selectedFolderId === null ? 'active' : ''}}"
        data-id="{{null}}"
        bindtap="onSelectFolder"
      >
        <view class="folder-icon">ğŸ“</view>
        <text class="folder-name">å…¨éƒ¨</text>
      </view>
      
      <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
      <view 
        class="folder-item {{selectedFolderId === item.id ? 'active' : ''}}"
        wx:for="{{folders}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onSelectFolder"
        bindlongpress="onFolderLongPress"
      >
        <view class="folder-icon">ğŸ“‚</view>
        <text class="folder-name">{{item.name}}</text>
        <text class="folder-count" wx:if="{{item.card_count > 0}}">({{item.card_count}})</text>
      </view>
    </scroll-view>
    
    <!-- æ— æ–‡ä»¶å¤¹æç¤º -->
    <view class="folder-empty" wx:if="{{folders.length === 0}}">
      <text class="folder-empty-text">æš‚æ— æ–‡ä»¶å¤¹ï¼Œç‚¹å‡»"æ–°å»º"åˆ›å»º</text>
    </view>
  </view>

  <!-- å¡ç‰‡åˆ—è¡¨ -->
  <scroll-view 
    class="card-scroll {{activeTab === 'collected' ? 'with-folders' : ''}} {{viewMode !== 'list' ? 'with-view-mode' : ''}}"
    scroll-y
    refresher-enabled
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onReachBottom"
  >
    <!-- åˆ—è¡¨è§†å›¾ -->
    <view class="card-list" wx:if="{{viewMode === 'list' && cards.length > 0}}">
      <view 
        class="card-item" 
        wx:for="{{cards}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onCardTap"
        bindlongpress="onCardLongPress"
      >
        <!-- å¡ç‰‡å°é¢ -->
        <view class="card-cover">
          <image 
            src="{{item.media[0].thumbnail_url || item.media[0].url}}" 
            class="card-image" 
            mode="aspectFill"
            wx:if="{{item.media && item.media.length > 0}}"
          />
          <view class="card-placeholder" wx:else>
            <text class="placeholder-icon">ğŸ“·</text>
          </view>
          <!-- å¡ç‰‡ç±»å‹æ ‡ç­¾ -->
          <view class="card-type-tag">{{item.cardTypeLabel}}</view>
        </view>
        
        <!-- å¡ç‰‡ä¿¡æ¯ -->
        <view class="card-info">
          <text class="card-title text-ellipsis">{{item.title}}</text>
          <view class="card-meta">
            <text class="card-date">{{item.formattedDate}}</text>
            <view class="card-stats">
              <text class="stat-item">â¤ï¸ {{item.like_count}}</text>
              <text class="stat-item">ğŸ’¬ {{item.comment_count}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´çº¿è§†å›¾ -->
    <!-- Requirements: 8.6 - æŒ‰æ—¥æœŸåˆ†ç»„ -->
    <view class="timeline-view" wx:if="{{viewMode === 'timeline' && timelineGroups.length > 0}}">
      <view class="timeline-group" wx:for="{{timelineGroups}}" wx:key="date" wx:for-item="group">
        <!-- æ—¥æœŸæ ‡é¢˜ -->
        <view class="timeline-header">
          <view class="timeline-dot"></view>
          <text class="timeline-date">{{group.dateLabel}}</text>
          <text class="timeline-count">({{group.cards.length}}å¼ )</text>
        </view>
        
        <!-- è¯¥æ—¥æœŸä¸‹çš„å¡ç‰‡ -->
        <view class="timeline-cards">
          <view 
            class="timeline-card-item" 
            wx:for="{{group.cards}}" 
            wx:key="id"
            wx:for-item="card"
            data-id="{{card.id}}"
            bindtap="onCardTap"
            bindlongpress="onCardLongPress"
          >
            <view class="timeline-card-cover">
              <image 
                src="{{card.media[0].thumbnail_url || card.media[0].url}}" 
                class="timeline-card-image" 
                mode="aspectFill"
                wx:if="{{card.media && card.media.length > 0}}"
              />
              <view class="timeline-card-placeholder" wx:else>
                <text class="placeholder-icon">ğŸ“·</text>
              </view>
            </view>
            <view class="timeline-card-info">
              <text class="timeline-card-title text-ellipsis">{{card.title}}</text>
              <view class="timeline-card-meta">
                <text class="timeline-card-type">{{card.cardTypeLabel}}</text>
                <view class="timeline-card-stats">
                  <text class="stat-item">â¤ï¸ {{card.like_count}}</text>
                  <text class="stat-item">ğŸ’¬ {{card.comment_count}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»è§†å›¾ -->
    <!-- Requirements: 8.7 - æŒ‰ç±»å‹åˆ†ç»„ -->
    <view class="category-view" wx:if="{{viewMode === 'category' && categoryGroups.length > 0}}">
      <view class="category-group" wx:for="{{categoryGroups}}" wx:key="cardType" wx:for-item="group">
        <!-- åˆ†ç±»æ ‡é¢˜ -->
        <view class="category-header">
          <text class="category-icon">{{group.typeIcon}}</text>
          <text class="category-name">{{group.typeLabel}}</text>
          <text class="category-count">({{group.count}}å¼ )</text>
        </view>
        
        <!-- è¯¥åˆ†ç±»ä¸‹çš„å¡ç‰‡ -->
        <view class="category-cards">
          <view 
            class="category-card-item" 
            wx:for="{{group.cards}}" 
            wx:key="id"
            wx:for-item="card"
            data-id="{{card.id}}"
            bindtap="onCardTap"
            bindlongpress="onCardLongPress"
          >
            <view class="category-card-cover">
              <image 
                src="{{card.media[0].thumbnail_url || card.media[0].url}}" 
                class="category-card-image" 
                mode="aspectFill"
                wx:if="{{card.media && card.media.length > 0}}"
              />
              <view class="category-card-placeholder" wx:else>
                <text class="placeholder-icon">ğŸ“·</text>
              </view>
            </view>
            <view class="category-card-info">
              <text class="category-card-title text-ellipsis">{{card.title}}</text>
              <view class="category-card-meta">
                <text class="category-card-date">{{card.formattedDate}}</text>
                <view class="category-card-stats">
                  <text class="stat-item">â¤ï¸ {{card.like_count}}</text>
                  <text class="stat-item">ğŸ’¬ {{card.comment_count}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading" wx:if="{{loading && cards.length > 0}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && cards.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>

    <!-- ç©ºçŠ¶æ€ - æ—¶é—´çº¿è§†å›¾ -->
    <view class="empty" wx:if="{{!loading && viewMode === 'timeline' && timelineGroups.length === 0 && cards.length === 0}}">
      <view class="empty-icon">ğŸ“…</view>
      <text class="empty-title">æš‚æ— å¡ç‰‡</text>
      <text class="empty-desc">{{activeTab === 'created' ? 'åˆ›å»ºå¡ç‰‡åå°†æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º' : 'æ”¶è—å¡ç‰‡åå°†æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º'}}</text>
    </view>

    <!-- ç©ºçŠ¶æ€ - åˆ†ç±»è§†å›¾ -->
    <view class="empty" wx:if="{{!loading && viewMode === 'category' && categoryGroups.length === 0 && cards.length === 0}}">
      <view class="empty-icon">ğŸ“‚</view>
      <text class="empty-title">æš‚æ— å¡ç‰‡</text>
      <text class="empty-desc">{{activeTab === 'created' ? 'åˆ›å»ºå¡ç‰‡åå°†æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º' : 'æ”¶è—å¡ç‰‡åå°†æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º'}}</text>
    </view>

    <!-- ç©ºçŠ¶æ€ - åˆ›å»ºçš„å¡ç‰‡ï¼ˆåˆ—è¡¨è§†å›¾ï¼‰ -->
    <view class="empty" wx:if="{{!loading && viewMode === 'list' && cards.length === 0 && activeTab === 'created'}}">
      <view class="empty-icon">ğŸ“</view>
      <text class="empty-title">è¿˜æ²¡æœ‰åˆ›å»ºå¡ç‰‡</text>
      <text class="empty-desc">è®°å½•ä½ çš„äººç”Ÿä½“éªŒï¼Œä¸ä»–äººåˆ†äº«ç²¾å½©æ—¶åˆ»</text>
      <button class="empty-btn" bindtap="onCreateCard">åˆ›å»ºç¬¬ä¸€å¼ å¡ç‰‡</button>
    </view>

    <!-- ç©ºçŠ¶æ€ - æ”¶è—çš„å¡ç‰‡ï¼ˆåˆ—è¡¨è§†å›¾ï¼‰ -->
    <view class="empty" wx:if="{{!loading && viewMode === 'list' && cards.length === 0 && activeTab === 'collected'}}">
      <view class="empty-icon">ğŸ’</view>
      <text class="empty-title">è¿˜æ²¡æœ‰æ”¶è—å¡ç‰‡</text>
      <text class="empty-desc">å‘ç°æ„Ÿå…´è¶£çš„å¡ç‰‡ï¼Œé€šè¿‡äº¤æ¢æ”¶è—å®ƒä»¬</text>
      <button class="empty-btn" bindtap="onGoDiscover">å»å‘ç°</button>
    </view>

    <!-- åˆå§‹åŠ è½½çŠ¶æ€ -->
    <view class="initial-loading" wx:if="{{loading && cards.length === 0}}">
      <view class="loading-spinner"></view>
      <text>åŠ è½½ä¸­...</text>
    </view>
  </scroll-view>

  <!-- æ–‡ä»¶å¤¹åˆ›å»º/é‡å‘½åå¼¹çª— -->
  <view class="modal-mask" wx:if="{{showFolderModal}}" bindtap="onCloseFolderModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">{{folderModalTitle}}</text>
        <view class="modal-close" bindtap="onCloseFolderModal">âœ•</view>
      </view>
      <view class="modal-body">
        <input 
          class="folder-input {{folderInputError ? 'error' : ''}}"
          placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°"
          value="{{folderInputValue}}"
          bindinput="onFolderInputChange"
          maxlength="50"
          focus="{{showFolderModal}}"
        />
        <text class="input-error" wx:if="{{folderInputError}}">{{folderInputError}}</text>
        <text class="input-hint">æœ€å¤š50ä¸ªå­—ç¬¦</text>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="onCloseFolderModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="onConfirmFolderModal">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ–‡ä»¶å¤¹æ“ä½œèœå• -->
  <view class="action-sheet-mask" wx:if="{{showFolderActionSheet}}" bindtap="onCloseFolderActionSheet">
    <view class="action-sheet" catchtap="">
      <view class="action-sheet-header">
        <text class="action-sheet-title">{{actionFolderName}}</text>
      </view>
      <view class="action-sheet-item" data-action="rename" bindtap="onFolderActionSelect">
        <text class="action-icon">âœï¸</text>
        <text class="action-text">é‡å‘½å</text>
      </view>
      <view class="action-sheet-item danger" data-action="delete" bindtap="onFolderActionSelect">
        <text class="action-icon">ğŸ—‘ï¸</text>
        <text class="action-text">åˆ é™¤</text>
      </view>
      <view class="action-sheet-cancel" bindtap="onCloseFolderActionSheet">
        <text>å–æ¶ˆ</text>
      </view>
    </view>
  </view>

  <!-- ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹é€‰æ‹©é¢æ¿ -->
  <!-- Requirements: 8.4 -->
  <view class="action-sheet-mask" wx:if="{{showMoveToFolderSheet}}" bindtap="onCloseMoveToFolderSheet">
    <view class="action-sheet move-folder-sheet" catchtap="">
      <view class="action-sheet-header">
        <text class="action-sheet-title">ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹</text>
        <text class="action-sheet-subtitle">{{movingCardTitle}}</text>
      </view>
      
      <!-- æœªåˆ†ç±»é€‰é¡¹ -->
      <view class="folder-select-item" data-id="{{null}}" bindtap="onSelectTargetFolder">
        <view class="folder-select-icon">ğŸ“</view>
        <text class="folder-select-name">æœªåˆ†ç±»</text>
        <text class="folder-select-hint">ç§»å‡ºæ‰€æœ‰æ–‡ä»¶å¤¹</text>
      </view>
      
      <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
      <view 
        class="folder-select-item" 
        wx:for="{{folders}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onSelectTargetFolder"
      >
        <view class="folder-select-icon">ğŸ“‚</view>
        <text class="folder-select-name">{{item.name}}</text>
        <text class="folder-select-count" wx:if="{{item.card_count > 0}}">({{item.card_count}}å¼ )</text>
      </view>
      
      <!-- æ–°å»ºæ–‡ä»¶å¤¹é€‰é¡¹ -->
      <view class="folder-select-item create-new" bindtap="onCreateFolderFromMoveSheet">
        <view class="folder-select-icon">â•</view>
        <text class="folder-select-name">æ–°å»ºæ–‡ä»¶å¤¹</text>
      </view>
      
      <view class="action-sheet-cancel" bindtap="onCloseMoveToFolderSheet">
        <text>å–æ¶ˆ</text>
      </view>
    </view>
  </view>
</view>
