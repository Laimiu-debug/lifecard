<!--
  é€šçŸ¥é¡µé¢
  æ˜¾ç¤ºåˆ†ç»„é€šçŸ¥åˆ—è¡¨
  Requirements: 10.2, 10.3
-->
<view class="page-container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="header">
    <view class="header-left">
      <text class="header-title">é€šçŸ¥</text>
      <view class="unread-badge" wx:if="{{totalUnread > 0}}">
        {{totalUnread > 99 ? '99+' : totalUnread}}
      </view>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="onToggleView" wx:if="{{activeFilter === 'all'}}">
        <text class="action-icon">{{showGroupView ? 'ğŸ“‹' : 'ğŸ“'}}</text>
        <text class="action-text">{{showGroupView ? 'åˆ—è¡¨' : 'åˆ†ç»„'}}</text>
      </view>
      <view class="action-btn" bindtap="onMarkAllRead" wx:if="{{totalUnread > 0}}">
        <text class="action-icon">âœ“</text>
        <text class="action-text">å…¨éƒ¨å·²è¯»</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <scroll-view class="filter-scroll" scroll-x enable-flex>
    <view class="filter-container">
      <view 
        class="filter-item {{activeFilter === item.value ? 'active' : ''}}"
        wx:for="{{filterOptions}}"
        wx:key="value"
        data-filter="{{item.value}}"
        bindtap="onFilterChange"
      >
        <text>{{item.label}}</text>
      </view>
    </view>
  </scroll-view>

  <!-- åˆ†ç»„è§†å›¾ -->
  <view class="notification-groups" wx:if="{{showGroupView && activeFilter === 'all'}}">
    <block wx:for="{{groupedNotifications}}" wx:key="type">
      <view class="notification-group">
        <!-- åˆ†ç»„æ ‡é¢˜ -->
        <view class="group-header" data-type="{{item.type}}" bindtap="onGroupTap">
          <view class="group-title">
            <text class="group-icon">{{item.icon}}</text>
            <text class="group-name">{{item.title}}</text>
            <view class="group-badge" wx:if="{{item.unreadCount > 0}}">
              {{item.unreadCount > 99 ? '99+' : item.unreadCount}}
            </view>
          </view>
          <view class="group-arrow">
            <text class="arrow-icon">â€º</text>
          </view>
        </view>

        <!-- åˆ†ç»„å†…æœ€æ–°é€šçŸ¥é¢„è§ˆï¼ˆæœ€å¤šæ˜¾ç¤º3æ¡ï¼‰ -->
        <view class="group-preview">
          <block wx:for="{{item.notifications}}" wx:for-item="notification" wx:key="id" wx:for-index="idx">
            <view 
              class="preview-item {{notification.is_read ? '' : 'unread'}}"
              wx:if="{{idx < 3}}"
              data-id="{{notification.id}}"
              bindtap="onNotificationTap"
              bindlongpress="onNotificationLongPress"
            >
              <!-- å‘é€è€…å¤´åƒ -->
              <view class="sender-avatar" wx:if="{{notification.sender}}" data-sender-id="{{notification.sender_id}}" catchtap="onSenderTap">
                <image 
                  src="{{notification.sender.avatar_url || '/assets/images/default-avatar.png'}}" 
                  class="avatar-image"
                  mode="aspectFill"
                />
              </view>
              <view class="sender-avatar default" wx:else>
                <text class="avatar-icon">{{notification.typeIcon}}</text>
              </view>

              <!-- é€šçŸ¥å†…å®¹ -->
              <view class="preview-content">
                <view class="preview-title">
                  <text class="sender-name" wx:if="{{notification.sender}}">{{notification.sender.nickname}}</text>
                  <text class="notification-action">{{notification.title}}</text>
                </view>
                <text class="preview-text">{{notification.content}}</text>
                <text class="preview-time">{{notification.formattedTime}}</text>
              </view>

              <!-- æœªè¯»æ ‡è®° -->
              <view class="unread-dot" wx:if="{{!notification.is_read}}"></view>
            </view>
          </block>

          <!-- æŸ¥çœ‹æ›´å¤š -->
          <view class="view-more" wx:if="{{item.notifications.length > 3}}" data-type="{{item.type}}" bindtap="onGroupTap">
            <text class="view-more-text">æŸ¥çœ‹å…¨éƒ¨ {{item.notifications.length}} æ¡</text>
            <text class="view-more-arrow">â€º</text>
          </view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && groupedNotifications.length === 0}}">
      <view class="empty-icon">ğŸ””</view>
      <text class="empty-title">æš‚æ— é€šçŸ¥</text>
      <text class="empty-desc">å½“æœ‰äººä¸ä½ äº’åŠ¨æ—¶ï¼Œä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</text>
    </view>
  </view>

  <!-- åˆ—è¡¨è§†å›¾ -->
  <view class="notification-list" wx:else>
    <block wx:for="{{notifications}}" wx:key="id">
      <view 
        class="notification-item {{item.is_read ? '' : 'unread'}}"
        data-id="{{item.id}}"
        bindtap="onNotificationTap"
        bindlongpress="onNotificationLongPress"
      >
        <!-- å‘é€è€…å¤´åƒ -->
        <view class="notification-avatar" wx:if="{{item.sender}}" data-sender-id="{{item.sender_id}}" catchtap="onSenderTap">
          <image 
            src="{{item.sender.avatar_url || '/assets/images/default-avatar.png'}}" 
            class="avatar-image"
            mode="aspectFill"
          />
          <view class="type-badge">
            <text>{{item.typeIcon}}</text>
          </view>
        </view>
        <view class="notification-avatar default" wx:else>
          <text class="avatar-icon">{{item.typeIcon}}</text>
        </view>

        <!-- é€šçŸ¥å†…å®¹ -->
        <view class="notification-content">
          <view class="notification-header">
            <text class="sender-name" wx:if="{{item.sender}}">{{item.sender.nickname}}</text>
            <text class="notification-title">{{item.title}}</text>
          </view>
          <text class="notification-text">{{item.content}}</text>
          <view class="notification-meta">
            <text class="notification-type">{{item.typeLabel}}</text>
            <text class="notification-time">{{item.formattedTime}}</text>
          </view>
        </view>

        <!-- æœªè¯»æ ‡è®° -->
        <view class="unread-dot" wx:if="{{!item.is_read}}"></view>
      </view>
    </block>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && notifications.length > 0}}">
      <view class="loading-spinner" wx:if="{{loading}}"></view>
      <text class="load-more-text">{{loading ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š'}}</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && notifications.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šäº†</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && notifications.length === 0}}">
      <view class="empty-icon">ğŸ””</view>
      <text class="empty-title">æš‚æ— {{activeFilterLabel}}é€šçŸ¥</text>
      <text class="empty-desc">å½“æœ‰äººä¸ä½ äº’åŠ¨æ—¶ï¼Œä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</text>
    </view>
  </view>

  <!-- å…¨å±€åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading && notifications.length === 0 && groupedNotifications.length === 0}}">
    <view class="loading-spinner large"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
