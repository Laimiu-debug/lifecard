<!--
  äº¤æ¢ç®¡ç†é¡µé¢
  æ˜¾ç¤ºå¾…å¤„ç†å’Œå·²å‘é€è¯·æ±‚
  Requirements: 7.5, 7.6, 7.7
-->
<view class="page-container">
  <!-- Tab åˆ‡æ¢ -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 'received' ? 'active' : ''}}"
      data-tab="received"
      bindtap="onTabChange"
    >
      <text>æ”¶åˆ°çš„è¯·æ±‚</text>
      <view class="tab-badge" wx:if="{{pendingTotal > 0}}">{{pendingTotal > 99 ? '99+' : pendingTotal}}</view>
    </view>
    <view 
      class="tab-item {{activeTab === 'sent' ? 'active' : ''}}"
      data-tab="sent"
      bindtap="onTabChange"
    >
      <text>å‘å‡ºçš„è¯·æ±‚</text>
      <view class="tab-badge" wx:if="{{sentTotal > 0}}">{{sentTotal > 99 ? '99+' : sentTotal}}</view>
    </view>
  </view>

  <!-- æ”¶åˆ°çš„è¯·æ±‚åˆ—è¡¨ -->
  <view class="exchange-list" wx:if="{{activeTab === 'received'}}">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading" wx:if="{{pendingLoading && pendingRequests.length === 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- è¯·æ±‚åˆ—è¡¨ -->
    <block wx:for="{{pendingRequests}}" wx:key="id">
      <view class="exchange-item">
        <!-- è¯·æ±‚è€…ä¿¡æ¯ -->
        <view class="exchange-header" data-user-id="{{item.requester_id}}" bindtap="onUserTap">
          <image 
            src="{{item.requester.avatar_url || '/assets/images/default-avatar.png'}}" 
            class="user-avatar"
            mode="aspectFill"
          />
          <view class="user-info">
            <text class="user-name">{{item.requester.nickname || 'æœªçŸ¥ç”¨æˆ·'}}</text>
            <text class="request-time">{{item.formattedTime}}</text>
          </view>
          <view class="exchange-status status-{{item.status}}">
            {{item.statusText}}
          </view>
        </view>

        <!-- ç•™è¨€ -->
        <view class="exchange-message" wx:if="{{item.message}}">
          <text class="message-label">ç•™è¨€ï¼š</text>
          <text class="message-content">{{item.message}}</text>
        </view>

        <!-- å¡ç‰‡é¢„è§ˆ -->
        <view class="card-preview" data-card-id="{{item.card_id}}" bindtap="onCardTap">
          <image 
            src="{{item.card.media[0].thumbnail_url || item.card.media[0].url || '/assets/images/default-card.png'}}" 
            class="card-image" 
            mode="aspectFill"
            wx:if="{{item.card && item.card.media && item.card.media.length > 0}}"
          />
          <image 
            src="/assets/images/default-card.png" 
            class="card-image" 
            mode="aspectFill"
            wx:else
          />
          <view class="card-info">
            <text class="card-title">{{item.card.title || 'æœªçŸ¥å¡ç‰‡'}}</text>
            <view class="card-meta">
              <text class="card-type">{{item.card.card_type === 'day_card' ? 'ä¸€å¤©ä½“éªŒå¡' : item.card.card_type === 'week_card' ? 'ä¸€å‘¨ä½“éªŒå¡' : item.card.card_type === 'fragment_card' ? 'äººç”Ÿç‰‡æ®µå¡' : 'é‡è¦æ—¶åˆ»å¡'}}</text>
            </view>
            <view class="card-price">
              <text class="price-icon">ğŸª™</text>
              <text class="price-value">{{item.coin_cost}}</text>
              <text class="price-unit">é‡‘å¸</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® (ä»…å¾…å¤„ç†çŠ¶æ€æ˜¾ç¤º) -->
        <view class="exchange-actions" wx:if="{{item.status === 'pending'}}">
          <button class="action-btn reject-btn" data-id="{{item.id}}" bindtap="onReject">
            æ‹’ç»
          </button>
          <button class="action-btn accept-btn" data-id="{{item.id}}" bindtap="onAccept">
            æ¥å—
          </button>
        </view>

        <!-- çŠ¶æ€æç¤º (å·²å¤„ç†çš„è¯·æ±‚) -->
        <view class="status-hint accepted" wx:if="{{item.status === 'accepted'}}">
          <text class="hint-icon">âœ…</text>
          <text class="hint-text">å·²æ¥å—ï¼Œæ‚¨è·å¾—äº† {{item.coin_cost}} é‡‘å¸</text>
        </view>
        <view class="status-hint rejected" wx:if="{{item.status === 'rejected'}}">
          <text class="hint-icon">âŒ</text>
          <text class="hint-text">å·²æ‹’ç»æ­¤è¯·æ±‚</text>
        </view>
        <view class="status-hint expired" wx:if="{{item.status === 'expired'}}">
          <text class="hint-icon">â°</text>
          <text class="hint-text">è¯·æ±‚å·²è¿‡æœŸ</text>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!pendingLoading && pendingRequests.length === 0}}">
      <view class="empty-icon">ğŸ“­</view>
      <text class="empty-title">æš‚æ— æ”¶åˆ°çš„è¯·æ±‚</text>
      <text class="empty-desc">å½“æœ‰äººæƒ³è¦äº¤æ¢ä½ çš„å¡ç‰‡æ—¶ï¼Œä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</text>
    </view>
  </view>

  <!-- å‘å‡ºçš„è¯·æ±‚åˆ—è¡¨ -->
  <view class="exchange-list" wx:if="{{activeTab === 'sent'}}">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading" wx:if="{{sentLoading && sentRequests.length === 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- è¯·æ±‚åˆ—è¡¨ -->
    <block wx:for="{{sentRequests}}" wx:key="id">
      <view class="exchange-item">
        <!-- å¡ç‰‡æ‰€æœ‰è€…ä¿¡æ¯ -->
        <view class="exchange-header" data-user-id="{{item.card_owner_id}}" bindtap="onUserTap">
          <image 
            src="{{item.card_owner.avatar_url || '/assets/images/default-avatar.png'}}" 
            class="user-avatar"
            mode="aspectFill"
          />
          <view class="user-info">
            <text class="user-name">{{item.card_owner.nickname || 'æœªçŸ¥ç”¨æˆ·'}}</text>
            <text class="request-time">{{item.formattedTime}}</text>
          </view>
          <view class="exchange-status status-{{item.status}}">
            {{item.statusText}}
          </view>
        </view>

        <!-- ç•™è¨€ -->
        <view class="exchange-message" wx:if="{{item.message}}">
          <text class="message-label">æˆ‘çš„ç•™è¨€ï¼š</text>
          <text class="message-content">{{item.message}}</text>
        </view>

        <!-- å¡ç‰‡é¢„è§ˆ -->
        <view class="card-preview" data-card-id="{{item.card_id}}" bindtap="onCardTap">
          <image 
            src="{{item.card.media[0].thumbnail_url || item.card.media[0].url || '/assets/images/default-card.png'}}" 
            class="card-image" 
            mode="aspectFill"
            wx:if="{{item.card && item.card.media && item.card.media.length > 0}}"
          />
          <image 
            src="/assets/images/default-card.png" 
            class="card-image" 
            mode="aspectFill"
            wx:else
          />
          <view class="card-info">
            <text class="card-title">{{item.card.title || 'æœªçŸ¥å¡ç‰‡'}}</text>
            <view class="card-meta">
              <text class="card-type">{{item.card.card_type === 'day_card' ? 'ä¸€å¤©ä½“éªŒå¡' : item.card.card_type === 'week_card' ? 'ä¸€å‘¨ä½“éªŒå¡' : item.card.card_type === 'fragment_card' ? 'äººç”Ÿç‰‡æ®µå¡' : 'é‡è¦æ—¶åˆ»å¡'}}</text>
            </view>
            <view class="card-price">
              <text class="price-icon">ğŸª™</text>
              <text class="price-value">{{item.coin_cost}}</text>
              <text class="price-unit">é‡‘å¸</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® (ä»…å¾…å¤„ç†çŠ¶æ€æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®) -->
        <view class="exchange-actions" wx:if="{{item.status === 'pending'}}">
          <button class="action-btn cancel-btn" data-id="{{item.id}}" bindtap="onCancel">
            å–æ¶ˆè¯·æ±‚
          </button>
        </view>

        <!-- çŠ¶æ€æç¤º -->
        <view class="status-hint" wx:if="{{item.status === 'accepted'}}">
          <text class="hint-icon">âœ…</text>
          <text class="hint-text">äº¤æ¢æˆåŠŸï¼å¡ç‰‡å·²æ·»åŠ åˆ°ä½ çš„æ”¶è—</text>
        </view>
        <view class="status-hint rejected" wx:if="{{item.status === 'rejected'}}">
          <text class="hint-icon">âŒ</text>
          <text class="hint-text">å¯¹æ–¹æ‹’ç»äº†ä½ çš„è¯·æ±‚</text>
        </view>
        <view class="status-hint expired" wx:if="{{item.status === 'expired'}}">
          <text class="hint-icon">â°</text>
          <text class="hint-text">è¯·æ±‚å·²è¿‡æœŸ</text>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!sentLoading && sentRequests.length === 0}}">
      <view class="empty-icon">ğŸ“¤</view>
      <text class="empty-title">æš‚æ— å‘å‡ºçš„è¯·æ±‚</text>
      <text class="empty-desc">æµè§ˆå¡ç‰‡æ—¶ï¼Œç‚¹å‡»äº¤æ¢æŒ‰é’®å‘èµ·è¯·æ±‚</text>
    </view>
  </view>
</view>
